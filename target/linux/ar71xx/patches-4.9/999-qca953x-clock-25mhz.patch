From 941c5d4504552474188d36c02d466542ecfed6ac Mon Sep 17 00:00:00 2001
From: Robert Marko <robimarko@gmail.com>
Date: Sun, 5 Nov 2017 18:07:35 +0100
Subject: [PATCH] CPE210 v2 ref clock

Update dev-wmac.c
---
 arch/mips/ath79/clock.c    | 6 +++++-
 arch/mips/ath79/dev-wmac.c | 7 +++----
 2 files changed, 8 insertions(+), 5 deletions(-)

diff --git a/arch/mips/ath79/clock.c b/arch/mips/ath79/clock.c
index dad3d879..fe007b35 100644
--- a/arch/mips/ath79/clock.c
+++ b/arch/mips/ath79/clock.c
@@ -29,6 +29,8 @@
 #include "common.h"
 #include "machtypes.h"
 
+#include <asm/prom.h>
+
 #define AR71XX_BASE_FREQ	40000000
 #define AR724X_BASE_FREQ	40000000
 
@@ -367,7 +369,9 @@ static void __init qca953x_clocks_init(void)
 	u32 bootstrap;
 
 	bootstrap = ath79_reset_rr(QCA953X_RESET_REG_BOOTSTRAP);
-	if (bootstrap &	QCA953X_BOOTSTRAP_REF_CLK_40)
+	if (strcmp (mips_get_machine_name(), "TP-LINK CPE210 v2"))
+		ref_rate = 25 * 1000 * 1000;
+	else if (bootstrap &	QCA953X_BOOTSTRAP_REF_CLK_40)
 		ref_rate = 40 * 1000 * 1000;
 	else
 		ref_rate = 25 * 1000 * 1000;
diff --git a/arch/mips/ath79/dev-wmac.c b/arch/mips/ath79/dev-wmac.c
index 7b8a44f9..ad4faeb8 100644
--- a/arch/mips/ath79/dev-wmac.c
+++ b/arch/mips/ath79/dev-wmac.c
@@ -25,6 +25,8 @@
 #include "common.h"
 #include "dev-wmac.h"
 
+#include <asm/prom.h>
+
 static u8 ath79_wmac_mac[ETH_ALEN];
 
 static struct ath9k_platform_data ath79_wmac_data = {
@@ -162,10 +164,7 @@ static void qca953x_wmac_setup(void)
 	ath79_wmac_resources[1].end = ATH79_IP2_IRQ(1);
 
 	t = ath79_reset_rr(QCA953X_RESET_REG_BOOTSTRAP);
-	if (t & QCA953X_BOOTSTRAP_REF_CLK_40)
-		ath79_wmac_data.is_clk_25mhz = false;
-	else
-		ath79_wmac_data.is_clk_25mhz = true;
+	ath79_wmac_data.is_clk_25mhz = true;
 
 	ath79_wmac_data.get_mac_revision = ar93xx_get_soc_revision;
 }
